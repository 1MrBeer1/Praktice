{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="/static/css/files.css">

<div class="d-flex align-items-center mb-3">
  <h2 class="me-3">File Explorer</h2>
  <div class="ms-auto">
    <button class="btn btn-secondary me-2" onclick="goUp()">‚¨Ü Up</button>
    <button class="btn btn-success me-2" onclick="newFolder()">üìÅ New Folder</button>
    <button class="btn btn-primary me-2" onclick="newFile()">üìÑ New File</button>
    <label class="btn btn-warning me-2">
      ‚¨Ü Upload <input id="uploadInput" type="file" hidden onchange="uploadFile(event)">
    </label>
  </div>
</div>

<div class="mb-2">
<input id="pathInput" class="form-control" value="/" readonly>
</div>

<div id="breadcrumbs" class="mb-3 small text-muted"></div>

<div id="dropZone" class="drop-zone mb-3">Drag &amp; Drop files here to upload</div>

<div id="alert" class="alert alert-danger d-none" role="alert"></div>

<table class="table table-striped table-hover">
  <thead class="table-dark">
    <tr>
      <th style="width:40px"></th>
      <th>Name</th>
      <th style="width:140px">Type</th>
      <th style="width:120px">Size</th>
      <th style="width:140px">Actions</th>
    </tr>
  </thead>
  <tbody id="files-body"></tbody>
</table>

<!-- modal editor -->
<div id="editorModal" class="modal-overlay d-none">
  <div class="modal">
    <div class="modal-header">
      <h5 id="editorTitle">Edit file</h5>
      <button onclick="closeEditor()" class="btn-close">‚úñ</button>
    </div>
    <textarea id="editorArea" class="editor-textarea"></textarea>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveEditor()">Save</button>
      <button class="btn btn-secondary" onclick="closeEditor()">Close</button>
    </div>
  </div>
</div>

<script src="/static/js/files.js"></script>
{% endblock %}
from flask import Flask, jsonify, render_template, request, send_file
from flask_sqlalchemy import SQLAlchemy
from config import SQLALCHEMY_DATABASE_URI, SECRET_KEY, DEBUG

import os

db = SQLAlchemy()

# -----------------------------
# FILESYSTEM CONFIG
# -----------------------------
BASE_DIR = "/home/root"     # –ò–∑–º–µ–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

# >>> FIX: –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—É—Ç–µ–π
def safe_join(base, path):
    if path in ["", "/", None]:
        return base  # –ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è

    # –£–±–∏—Ä–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π /
    path = path.lstrip("/")

    final = os.path.abspath(os.path.join(base, path))

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ BASE_DIR
    if not final.startswith(base):
        raise ValueError("Forbidden path")

    return final



# >>> FIX: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–≤–æ–¥ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
def fs_list(path):
    abs_path = safe_join(BASE_DIR, path)

    items = []
    for item in os.listdir(abs_path):
        full = os.path.join(abs_path, item)

        items.append({
            "name": item,
            "path": ("/" if path in ["", "/"] else path.rstrip("/") + "/" + item),
            "is_dir": os.path.isdir(full),
            "size": os.path.getsize(full) if os.path.isfile(full) else None
        })

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç—å
    clean_path = "/" if path in ["", "/"] else path

    return {"path": clean_path, "items": items}



def fs_read(path):
    abs_path = safe_join(BASE_DIR, path)
    with open(abs_path, "r", encoding="utf-8") as f:
        return f.read()


def fs_write(path, content):
    abs_path = safe_join(BASE_DIR, path)
    with open(abs_path, "w", encoding="utf-8") as f:
        f.write(content)
    return True


def fs_delete(path):
    abs_path = safe_join(BASE_DIR, path)
    if os.path.isdir(abs_path):
        os.rmdir(abs_path)
    else:
        os.remove(abs_path)
    return True


def fs_create_folder(path, name):
    abs_path = safe_join(BASE_DIR, path, name)
    os.makedirs(abs_path, exist_ok=True)
    return True


def fs_upload(path, file):
    abs_path = safe_join(BASE_DIR, path, file.filename)
    file.save(abs_path)
    return True


# -----------------------------
# FLASK APP
# -----------------------------
def create_app():
    app = Flask(__name__)
    app.config['SECRET_KEY'] = SECRET_KEY
    app.config['SQLALCHEMY_DATABASE_URI'] = SQLALCHEMY_DATABASE_URI
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    app.debug = DEBUG

    db.init_app(app)

    with app.app_context():
        db.create_all()

    # -----------------------------
    # FRONTEND ROUTES
    # -----------------------------
    @app.route("/")
    def index():
        return render_template("index.html")

    @app.route("/files")
    def files_page():
        return render_template("files.html")

    @app.route("/hardware")
    def hardware_page():
        return render_template("Hardware.html")

    @app.route("/processes")
    def processes_page():
        return render_template("processes.html")

    # -----------------------------
    # FILESYSTEM API
    # -----------------------------

    @app.route("/api/files", methods=["GET"])
    def api_files_list():
        path = request.args.get("path", "/")
        return jsonify(fs_list(path))

    @app.route("/api/files/read", methods=["GET"])
    def api_files_read():
        path = request.args.get("path")
        return jsonify({"content": fs_read(path)})

    @app.route("/api/files", methods=["POST"])
    def api_files_create():
        data = request.json
        path = data["path"]
        name = data["name"]
        content = data.get("content", "")
        abs_path = (path.rstrip("/") + "/" + name).replace("//", "/")
        fs_write(abs_path, content)
        return jsonify(True)

    @app.route("/api/files/update", methods=["POST"])
    def api_files_update():
        data = request.json
        fs_write(data["path"], data["content"])
        return jsonify(True)

    @app.route("/api/files/delete", methods=["POST"])
    def api_files_delete():
        data = request.json
        fs_delete(data["path"])
        return jsonify(True)

    @app.route("/api/files/folder", methods=["POST"])
    def api_files_folder():
        data = request.json
        fs_create_folder(data["path"], data["name"])
        return jsonify(True)

    @app.route("/api/files/upload", methods=["POST"])
    def api_files_upload():
        path = request.form.get("path", "/")
        file = request.files["file"]
        fs_upload(path, file)
        return jsonify(True)

    @app.route("/api/files/download", methods=["GET"])
    def api_files_download():
        path = request.args.get("path")
        abs_path = safe_join(BASE_DIR, path)
        return send_file(abs_path, as_attachment=True)

    # -----------------------------
    # PROCESSES API (–æ—Å—Ç–∞–≤–∏–ª –∫–∞–∫ –µ—Å—Ç—å)
    # -----------------------------
    from modules.processes import list_processes, run_process, kill_process

    @app.route("/api/processes", methods=["GET"])
    def api_list_processes():
        return jsonify(list_processes())

    @app.route("/api/processes/run", methods=["POST"])
    def api_run_process():
        data = request.json
        return jsonify(run_process(data["command"]))

    @app.route("/api/processes/kill", methods=["POST"])
    def api_kill_process():
        data = request.json
        return jsonify(kill_process(data["pid"]))

    return app


# -----------------------------
# APP START
# -----------------------------
if __name__ == "__main__":
    app = create_app()
    app.run(host="0.0.0.0", port=5000)
from flask import Flask, jsonify, render_template, request
from flask_sqlalchemy import SQLAlchemy
from config import SQLALCHEMY_DATABASE_URI, SECRET_KEY, DEBUG

db = SQLAlchemy()

def create_app():
    app = Flask(__name__)
    app.config['SECRET_KEY'] = SECRET_KEY
    app.config['SQLALCHEMY_DATABASE_URI'] = SQLALCHEMY_DATABASE_URI
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    app.debug = DEBUG

    db.init_app(app)

    # Importing backend logic modules
    from modules.hardware import get_basic_info, get_system_metrics, get_temperatures, is_root
    from modules.files import list_files, read_file, create_file, update_file, delete_file, upload_file, create_folder
    from modules.processes import list_processes, run_process, kill_process

    with app.app_context():
        db.create_all()

    # -----------------------------
    # FRONTEND PAGES (for navbar)
    # -----------------------------

    @app.route("/")
    def index():
        return render_template("index.html")

    @app.route("/hardware")
    def hardware_page():
    	return render_template("Hardware.html", title="Hardware Info")


    @app.route("/files")
    def files_page():
        return render_template("files.html")

    @app.route("/processes")
    def processes_page():
        return render_template("processes.html")

    # -----------------------------
    # HARDWARE API
    # -----------------------------
    @app.route("/api/hardware")
    def api_hardware():
        return jsonify({
            "basic": get_basic_info(),
            "metrics": get_system_metrics(),
            "temps": get_temperatures(),
            "is_admin": is_root()
        })

    # -----------------------------
    # FILES API
    # -----------------------------
    @app.route("/api/files/folder", methods=["POST"])
    def api_create_folder():
        data = request.json
        return jsonify(create_folder(data["path"], data["name"]))


    # UPLOAD FILE
    @app.route("/api/files/upload", methods=["POST"])
    def api_upload():
        path = request.form.get("path")
        file = request.files["file"]
        return jsonify(upload_file(path, file))


    # DOWNLOAD FILE
    @app.route("/api/files/download", methods=["GET"])
    def api_download():
        path = request.args.get("path")
        return download_file(path)
    # -----------------------------
    # PROCESSES API
    # -----------------------------
    @app.route("/api/processes", methods=["GET"])
    def api_list_processes():
        return jsonify(list_processes())

    @app.route("/api/processes/run", methods=["POST"])
    def api_run_process():
        data = request.json
        command = data.get("command")
        return jsonify(run_process(command))

    @app.route("/api/processes/kill", methods=["POST"])
    def api_kill_process():
        data = request.json
        pid = data.get("pid")
        return jsonify(kill_process(pid))

    return app


# -----------------------------
# APP START
# -----------------------------
if __name__ == "__main__":
    app = create_app()
    app.run(host="0.0.0.0", port=5000)
import os

BASE_DIR = "/home/root"   # –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ –ª—é–±–æ–µ –∫–æ—Ä–Ω–µ–≤–æ–µ –º–µ—Å—Ç–æ


def safe_join(base, *paths):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—É—Ç–µ–π (–Ω–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç –≤—ã—Ö–æ–¥ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã BASE_DIR)."""
    final_path = os.path.abspath(os.path.join(base, *paths))
    if not final_path.startswith(base):
        raise ValueError("Forbidden path")
    return final_path


def list_files(path=""):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫."""
    target_dir = safe_join(BASE_DIR, path)

    items = []
    for item in os.listdir(target_dir):
        full = os.path.join(target_dir, item)
        items.append({
            "name": item,
            "is_dir": os.path.isdir(full),
            "size": os.path.getsize(full) if os.path.isfile(full) else None
        })

    return items


def create_file(path, filename, content=""):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª."""
    target_path = safe_join(BASE_DIR, path, filename)

    with open(target_path, "w", encoding="utf-8") as f:
        f.write(content)

    return True


def delete_file(path, filename):
    """–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª."""
    target_path = safe_join(BASE_DIR, path, filename)

    if os.path.isdir(target_path):
        os.rmdir(target_path)
    else:
        os.remove(target_path)

    return True


def read_file(path, filename):
    """–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª."""
    target_path = safe_join(BASE_DIR, path, filename)

    with open(target_path, "r", encoding="utf-8") as f:
        return f.read()


def update_file(path, filename, content):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞."""
    target_path = safe_join(BASE_DIR, path, filename)

    with open(target_path, "w", encoding="utf-8") as f:
        f.write(content)

    return True
